@model teduWallet.Models.ViewModels.StudentRewardsViewModel
@{
    ViewData["Title"] = "Rewards Shop";
}

<div class="container-fluid">
    <div class="row mb-4 align-items-center">
        <div class="col">
            <h2 class="fw-bold">Rewards</h2>
            <p class="text-muted mb-0">Exchange coins or view your purchased rewards.</p>
        </div>
        <div class="col-auto">
            <div class="bg-primary bg-opacity-10 text-primary px-4 py-2 rounded-pill fw-bold">
                 <i class="bi bi-wallet2 me-2"></i> Balance: @Model.CurrentBalance.ToString("N0") TDC
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-pills mb-4" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active rounded-pill fw-bold px-4" id="pills-shop-tab" data-bs-toggle="pill"
                data-bs-target="#pills-shop" type="button" role="tab">
                <i class="bi bi-shop me-2"></i> Reward Shop
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link rounded-pill fw-bold px-4" id="pills-my-rewards-tab" data-bs-toggle="pill"
                data-bs-target="#pills-my-rewards" type="button" role="tab">
                <i class="bi bi-gift me-2"></i> My Rewards
            </button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        <!-- SHOP TAB -->
        <div class="tab-pane fade show active" id="pills-shop" role="tabpanel">
            <div class="row g-4">
                @if (!Model.AvailableRewards.Any())
                {
                    <div class="col-12">
                        <div class="alert alert-info rounded-4 border-0 shadow-sm p-4">
                             <i class="bi bi-shop me-2"></i> No rewards are currently available in the shop.
                        </div>
                    </div>
                }
                else 
                {
                    @foreach (var reward in Model.AvailableRewards)
                    {
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100 position-relative" style="border-radius: 20px; @(Model.CurrentBalance < reward.Cost ? "opacity: 0.8;" : "")">
                                <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="border-radius: 20px 20px 0 0; height: 180px;">
                                    <i class="bi bi-gift fs-1 text-secondary opacity-25"></i>
                                </div>
                                <div class="card-body p-4">
                                    <h5 class="fw-bold">@reward.RewardName</h5>
                                    <p class="text-muted small">@reward.Vendor</p>
                                    @if (Model.CurrentBalance < reward.Cost)
                                    {
                                        <div class="position-absolute top-0 end-0 m-3">
                                            <span class="badge bg-danger bg-opacity-75 rounded-pill px-3 py-2">
                                                <i class="bi bi-x-circle me-1"></i> Insufficient Funds
                                            </span>
                                        </div>
                                    }
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="fw-bold text-primary">@reward.Cost.ToString("N0") Coins</span>
                                        @if (Model.CurrentBalance >= reward.Cost)
                                        {
                                             <button type="button" class="btn btn-outline-primary btn-sm rounded-pill px-4"
                                                     data-bs-toggle="modal" data-bs-target="#confirmRedeemModal-@reward.RewardId">
                                                 Redeem
                                             </button>

                                             <div class="modal fade" id="confirmRedeemModal-@reward.RewardId" tabindex="-1" aria-hidden="true">
                                                 <div class="modal-dialog modal-dialog-centered">
                                                     <div class="modal-content rounded-4 border-0" style="background-color: var(--bs-body-bg); box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;">
                                                         <div class="modal-body p-4 text-center">
                                                             <div class="mb-3 text-primary bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                                                 <i class="bi bi-cart-check fs-2"></i>
                                                             </div>
                                                             <h5 class="fw-bold mb-2">Redeem Reward?</h5>
                                                             <p class="text-muted mb-4">
                                                                 Spend <strong>@reward.Cost Coins</strong> to get "<strong>@reward.RewardName</strong>"?
                                                             </p>
                                                             <div class="d-flex justify-content-center gap-2">
                                                                 <button type="button" class="btn btn-light rounded-pill px-4 fw-bold" data-bs-dismiss="modal">Cancel</button>
                                                                 <form asp-action="RedeemReward" method="post">
                                                                     <input type="hidden" name="rewardId" value="@reward.RewardId" />
                                                                     <button type="submit" class="btn btn-primary rounded-pill px-4 fw-bold">Confirm Redeem</button>
                                                                 </form>
                                                             </div>
                                                         </div>
                                                     </div>
                                                 </div>
                                             </div>
                                        }
                                        else
                                        {
                                            <button class="btn btn-outline-secondary btn-sm rounded-pill px-4" disabled>Insufficient Coins</button>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>

        <!-- MY REWARDS TAB -->
        <div class="tab-pane fade" id="pills-my-rewards" role="tabpanel">
             <div class="row g-4">
                @if (Model.MyRewards == null || !Model.MyRewards.Any())
                {
                    <div class="col-12">
                        <div class="alert alert-light rounded-4 border-0 shadow-sm p-4 text-center">
                             <div class="mb-3"><i class="bi bi-inbox fs-1 text-muted opacity-50"></i></div>
                             <p class="text-muted mb-0">You haven't redeemed any rewards yet.</p>
                        </div>
                    </div>
                }
                else 
                {
                    @foreach (var spend in Model.MyRewards)
                    {
                        var reward = spend.Reward; 
                        /* Assuming Reward navigation property is loaded */
                        
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100" style="border-radius: 20px;">
                                <div class="card-body p-4">
                                    <div class="d-flex align-items-start justify-content-between mb-3">
                                        <div>
                                            <h5 class="fw-bold mb-1">@reward?.RewardName</h5>
                                            <small class="text-muted">Redeemed: @spend.SpentDate.ToString("MMM dd, yyyy")</small>
                                        </div>
                                        <div class="bg-success bg-opacity-10 text-success p-2 rounded-circle">
                                            <i class="bi bi-check-lg"></i>
                                        </div>
                                    </div>
                                    <hr class="border-light opacity-50 my-3"/>
                                    <div class="d-grid">
                                        <button type="button" class="btn btn-outline-dark rounded-pill fw-bold"
                                                data-bs-toggle="modal" data-bs-target="#infoModal-@spend.TransactionId">
                                            View Code
                                        </button>
                                    </div>

                                     <!-- Info Modal -->
                                     <div class="modal fade" id="infoModal-@spend.TransactionId" tabindex="-1" aria-hidden="true" 
                                          data-reward-id="@reward?.RewardId">
                                         <div class="modal-dialog modal-dialog-centered">
                                             <div class="modal-content rounded-4 border-0" style="background-color: var(--bs-body-bg); box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;">
                                                 <div class="modal-header border-0 pb-0">
                                                     <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                 </div>
                                                 <div class="modal-body p-4 text-center pt-0">
                                                     <div class="mb-3 text-success bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                                                         <i class="bi bi-qr-code fs-1"></i>
                                                     </div>
                                                     <h4 class="fw-bold mb-1">@reward?.RewardName</h4>
                                                     <p class="text-muted small mb-4">@reward?.Vendor</p>
                                                     
                                                     <div class="bg-light p-3 rounded-3 mb-3 border border-dashed">
                                                         <div class="small text-uppercase text-muted fw-bold mb-1">Your Code</div>
                                                         <div class="fs-2 fw-bold letter-spacing-2 text-dark user-select-all">
                                                             @reward?.UniqueCode
                                                         </div>
                                                     </div>
                                                     
                                                     <p class="text-muted small mb-0">
                                                         Permissions: Show this code to the vendor to claim your item.
                                                         <br>Expired: @(reward?.ExpiryDate?.ToString("MMM dd, yyyy") ?? "Never")
                                                     </p>
                                                 </div>
                                             </div>
                                         </div>
                                     </div>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

@if (TempData["RedeemedRewardId"] != null)
{
    // Logic to auto-open the first matching modal in My Rewards
    // Since we don't have TransactionId easily here without looping, 
    // we can rely on data-attributes or just show a general success modal.
    // However, the request asked to "display ... popup ... after redeeming".
    // We can filter the list in JS or server-side.
    // Simpler: Use JS to find the modal with the matching reward ID in 'My Rewards' tab.
    // Note: A user might have multiple redemptions of same reward. We want the latest.
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var redeemedId = '@TempData["RedeemedRewardId"]';
            // Switch to My Rewards tab
            var tabTrigger = new bootstrap.Tab(document.querySelector('#pills-my-rewards-tab'));
            tabTrigger.show();
            
            // Find the modal for this reward. 
            // In My Rewards loop, we added data-reward-id to the modal.
            // We want the *first* one found in DOM (which is latest due to OrderByDescending in Controller)
            var modals = document.querySelectorAll('.modal[data-reward-id="' + redeemedId + '"]');
            if(modals.length > 0) {
                var myModal = new bootstrap.Modal(modals[0]);
                myModal.show();
            }
        });
    </script>
}

<style>
    .letter-spacing-2 {
        letter-spacing: 2px;
    }
    .border-dashed {
        border-style: dashed !important;
    }
    .nav-pills .nav-link.active {
        background-color: #0d6efd;
    }
    .nav-pills .nav-link {
        color: #495057;
    }
</style>
