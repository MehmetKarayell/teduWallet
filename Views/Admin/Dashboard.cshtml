@{
    ViewData["Title"] = "System Overview";
    Layout = "_AdminLayout";
}

<style>
    /* STRICT GLOBAL SCROLL LOCK */
    html, body {
        overflow: hidden !important;
        height: 100vh !important;
        margin: 0 !important;
    }

    /* Layout Adjustments */
    :root {
        --gap-size: 0.75rem;
    }

    /* Target the parent container from _AdminLayout context */
    .container-fluid {
        padding-bottom: 0 !important; /* Remove bottom padding validity */
        height: calc(100vh - 75px); /* Fit within viewport minus navbar */
        overflow: hidden !important;
    }

    /* Main Dashboard Wrapper */
    .viewport-fit-container {
        height: 100%;
        display: flex;
        flex-direction: column;
        gap: var(--gap-size);
        overflow: hidden;
    }

    /* 1. Header */
    .dashboard-header {
        flex: 0 0 auto;
    }
    .welcome-title {
        font-size: 1.5rem !important;
        margin-bottom: 0.25rem !important;
    }
    
    /* 2. Stats Grid */
    .dashboard-stats {
        flex: 0 0 auto;
    }
    .stat-card-compact {
        padding: 0.75rem !important;
        border-radius: 16px !important;
    }
    .stat-icon-box {
        width: 40px; 
        height: 40px; 
        padding: 0.5rem; 
        margin-right: 0.75rem !important;
    }
    .stat-val { font-size: 1.5rem !important; }

    /* 3. Bottom Split - Fills rest of screen */
    .dashboard-bottom-split {
        flex: 1;
        display: grid;
        grid-template-columns: 1fr 1fr; /* 50/50 Split */
        gap: 1rem;
        min-height: 0;
    }

    .dashboard-panel-card {
        height: 100%;
        display: flex;
        flex-direction: column;
        background: white;
        border-radius: 20px;
        box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);
        padding: 1rem;
        overflow: hidden;
    }

    .panel-header {
        flex: 0 0 auto;
        margin-bottom: 1rem;
        font-weight: bold;
        font-size: 1.1rem;
    }

    .panel-body-scroll {
        flex: 1;
        overflow-y: auto;
        padding-right: 5px;
    }
    /* Hide scrollbar for cleaner look */
    .panel-body-scroll::-webkit-scrollbar { width: 4px; }
    .panel-body-scroll::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

    /* Governance Buttons Compact */
    .btn-governance {
        padding: 0.75rem 1rem !important;
        font-size: 0.9rem !important;
        box-shadow: 0 .125rem .25rem rgba(0,0,0,.075) !important; /* Soft shadow */
        border: 0 !important; /* Cleaner look */
        transition: transform 0.2s;
    }
    .btn-governance:hover {
        transform: translateY(-2px);
    }

    /* Governance Colors */
    .btn-gov-permissions { background-color: #3b82f6 !important; color: white !important; } /* Blue */
    .btn-gov-permissions:hover { background-color: #2563eb !important; color: white !important; }

    .btn-gov-new-activity { background-color: #facc15 !important; color: #1e293b !important; } /* Yellow */
    .btn-gov-new-activity:hover { background-color: #eab308 !important; color: #1e293b !important; } /* darker yellow on hover */

    .btn-gov-manage-activities { background-color: #f97316 !important; color: white !important; } /* Orange */
    .btn-gov-manage-activities:hover { background-color: #ea580c !important; color: white !important; }

    .btn-gov-new-reward { background-color: #a855f7 !important; color: white !important; } /* Purple */
    .btn-gov-new-reward:hover { background-color: #9333ea !important; color: white !important; }

    .btn-gov-manage-rewards { background-color: #22c55e !important; color: white !important; } /* Green */
    .btn-gov-manage-rewards:hover { background-color: #16a34a !important; color: white !important; }

    /* Log Items Compact */
    .log-item-compact {
        padding-left: 0; padding-right: 0; border: 0; margin-bottom: 0.5rem !important;
    }
    .log-title { font-size: 0.9rem; font-weight: bold; }
    .log-meta { font-size: 0.75rem; }

</style>

<div class="viewport-fit-container">
    
    <!-- 1. Header -->
    <div class="dashboard-header">
         <h1 class="fw-bold display-5 welcome-title">System Overview üõ°Ô∏è</h1>
         <p class="text-muted small mb-0">Operational metrics and controls.</p>
    </div>

    <!-- 2. Stats -->
    <div class="dashboard-stats">
        <div class="row g-3">
             <div class="col-md-3">
                <div class="card border-0 shadow-sm stat-card-compact">
                    <div class="card-body p-0">
                        <div class="d-flex align-items-center mb-2">
                            <div class="rounded-circle bg-primary bg-opacity-10 text-primary stat-icon-box d-flex align-items-center justify-content-center">
                                <i class="bi bi-people fs-6"></i>
                            </div>
                            <h6 class="mb-0 fw-bold small text-muted">Students</h6>
                        </div>
                        <h2 class="mb-0 fw-bold stat-val">@(ViewBag.TotalStudentsCount ?? 0)</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm stat-card-compact">
                    <div class="card-body p-0">
                        <div class="d-flex align-items-center mb-2">
                            <div class="rounded-circle bg-warning bg-opacity-10 text-warning stat-icon-box d-flex align-items-center justify-content-center">
                                <i class="bi bi-activity fs-6"></i>
                            </div>
                            <h6 class="mb-0 fw-bold small text-muted">Activities</h6>
                        </div>
                        <h2 class="mb-0 fw-bold stat-val">@(ViewBag.ActiveActivitiesCount ?? 0)</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm stat-card-compact">
                    <div class="card-body p-0">
                        <div class="d-flex align-items-center mb-2">
                            <div class="rounded-circle bg-success bg-opacity-10 text-success stat-icon-box d-flex align-items-center justify-content-center">
                                <i class="bi bi-check2-all fs-6"></i>
                            </div>
                            <h6 class="mb-0 fw-bold small text-muted">Pending</h6>
                        </div>
                        <div class="d-flex align-items-baseline justify-content-between">
                            <h2 class="mb-0 fw-bold stat-val">@(ViewBag.PendingCount ?? 0)</h2>
                            <a asp-action="PendingApprovals" class="small text-primary text-decoration-none fw-bold">View</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm stat-card-compact">
                    <div class="card-body p-0">
                        <div class="d-flex align-items-center mb-2">
                            <div class="rounded-circle bg-info bg-opacity-10 text-info stat-icon-box d-flex align-items-center justify-content-center">
                                <i class="bi bi-gear-fill fs-6"></i>
                            </div>
                            <h6 class="mb-0 fw-bold small text-muted">Status</h6>
                        </div>
                         <h2 class="mb-0 fw-bold text-success stat-val">OK</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. Bottom Split -->
    <div class="dashboard-bottom-split">
        
        <!-- Left: Quick Governance -->
        <div class="dashboard-panel-card">
            <div class="panel-header">Quick Governance</div>
            <div class="d-grid gap-2 overflow-hidden"> <!-- Prevent scroll here -->
                <a asp-action="Users" class="btn btn-gov-permissions rounded-pill btn-governance d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-shield-check me-2"></i> Permissions</span>
                    <i class="bi bi-chevron-right small"></i>
                </a>
                <a asp-controller="Activity" asp-action="AddActivity" class="btn btn-gov-new-activity rounded-pill btn-governance d-flex justify-content-between align-items-center fw-bold">
                    <span><i class="bi bi-plus-circle me-2"></i> New Activity</span>
                    <i class="bi bi-chevron-right small"></i>
                </a>
                 <a asp-controller="Activity" asp-action="ManageActivities" class="btn btn-gov-manage-activities rounded-pill btn-governance d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-list-check me-2"></i> Manage Activities</span>
                    <i class="bi bi-chevron-right small"></i>
                </a>
                <a asp-controller="Reward" asp-action="AddReward" class="btn btn-gov-new-reward rounded-pill btn-governance d-flex justify-content-between align-items-center fw-bold">
                    <span><i class="bi bi-gift-fill me-2"></i> New Reward</span>
                    <i class="bi bi-chevron-right small"></i>
                </a>
                 <a asp-controller="Reward" asp-action="ManageRewards" class="btn btn-gov-manage-rewards rounded-pill btn-governance d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-gift me-2"></i> Manage Rewards</span>
                    <i class="bi bi-chevron-right small"></i>
                </a>
            </div>
        </div>

        <!-- Right: Notifications -->
        <div class="dashboard-panel-card">
            <div class="panel-header d-flex justify-content-between align-items-center">
                <span>System Log</span>
                <div class="d-flex gap-1">
                    <button class="btn btn-xs btn-dark rounded-pill px-2 py-0" style="font-size: 0.7rem;" onclick="filterLogs('all')">All</button>
                    <button class="btn btn-xs btn-outline-dark rounded-pill px-2 py-0" style="font-size: 0.7rem;" onclick="filterLogs('APPLY')">Apps</button>
                    <button class="btn btn-xs btn-outline-dark rounded-pill px-2 py-0" style="font-size: 0.7rem;" onclick="filterLogs('COMPLETED')">Done</button>
                </div>
            </div>
            
            <div class="panel-body-scroll list-group list-group-flush">
                @if (ViewBag.Logs != null)
                {
                    @foreach (var log in (List<teduWallet.Models.Log>)ViewBag.Logs)
                    {
                        <div class="list-group-item log-item log-item-compact" data-category="@log.ActionType">
                            <div class="d-flex w-100 justify-content-between">
                                <span class="log-title @(log.ActionType == "APPLY" ? "text-primary" : "text-dark")">
                                    @if(log.ActionType == "APPLY") { <text>New Application</text> }
                                    else if(log.ActionType == "COMPLETED") { <text>Task Done</text> }
                                    else { @log.ActionType }
                                </span>
                                <small class="text-muted" style="font-size: 0.7rem;">@log.Timestamp?.ToString("HH:mm")</small>
                            </div>
                            <p class="mb-0 text-muted log-meta text-truncate">
                                @if(log.Student != null) { @log.Student.Name } 
                                @if(log.ActionType == "APPLY") { <text>applied for task.</text> }
                                else { <text>interaction.</text> }
                            </p>
                        </div>
                    }
                }
                else
                {
                     <div class="text-muted text-center py-3 small">No logs.</div>
                }
            </div>
        </div>

    </div>
</div>

<script>
    function filterLogs(category) {
        const items = document.querySelectorAll('.log-item');
        items.forEach(item => {
            if (category === 'all' || item.getAttribute('data-category') === category || 
               (category === 'COMPLETED' && item.getAttribute('data-category') === 'EARN')) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
</script>
